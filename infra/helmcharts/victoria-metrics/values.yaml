victoria-metrics-single:
  server:
    # Retention period для метрик
    retentionPeriod: 30d
    
    # Persistent storage
    persistentVolume:
      enabled: true
      size: 30Gi
      storageClass: ""
    
    # Resources
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi
    
    # Scraping configuration
    scrape:
      enabled: true
      config:
        global:
          scrape_interval: 15s
          scrape_timeout: 10s
        
        scrape_configs:
          # Kubernetes pods (backend, frontend, and any other services)
          - job_name: 'kubernetes-pods'
            kubernetes_sd_configs:
              - role: pod
                namespaces:
                  names:
                    - default
            relabel_configs:
              # Keep only pods with prometheus.io/scrape=true annotation
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              # Keep only the metrics port (not http port)
              - source_labels: [__meta_kubernetes_pod_container_port_name]
                action: keep
                regex: metrics
              # Set address to pod IP and port number
              - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_container_port_number]
                action: replace
                target_label: __address__
                regex: ([^:]+);(\d+)
                replacement: $1:$2
              # Use path from annotation (default to /metrics)
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              # Add pod name label
              - source_labels: [__meta_kubernetes_pod_name]
                target_label: pod
              # Add namespace label
              - source_labels: [__meta_kubernetes_namespace]
                target_label: namespace
              # Add service label from app.kubernetes.io/name
              - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
                action: replace
                target_label: service
    
    # Service configuration
    service:
      type: ClusterIP
      port: 8428
      annotations: {}
    
    # Ingress (опционально)
    ingress:
      enabled: false
      annotations: {}
      hosts:
        - host: victoria-metrics.example.com
          paths:
            - path: /
              pathType: Prefix

