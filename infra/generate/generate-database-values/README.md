# Database Values Generator

Автоматически генерирует Helm values файлы для PostgreSQL баз данных на основе конфигурации сервисов.

## Как это работает

1. Читает `services.yaml` и находит все сервисы с `database.enabled: true`
2. Для каждого сервиса генерирует два файла:
   - `infra/overrides/development/postgresql-{service}.yaml`
   - `infra/overrides/production/postgresql-{service}.yaml`
3. Использует разные ресурсы и размеры хранилища для разных окружений

## Конфигурация сервиса

В `services.yaml` добавьте секцию `database` для сервиса:

```yaml
services:
  nest:
    - name: backend
      description: Backend service (NestJS)
      database:
        enabled: true
        name: backend_db # опционально, по умолчанию: {service}_db
        user: backend_user # опционально, по умолчанию: {service}_user
```

## Генерируемые значения

### Development

- Persistence: 5Gi
- CPU: 50m-250m
- Memory: 128Mi-256Mi

### Production

- Persistence: 20Gi
- CPU: 250m-1000m
- Memory: 512Mi-1Gi

## Использование

Генератор запускается автоматически при выполнении:

```bash
pnpm run generate
```

Или отдельно:

```bash
tsx infra/generate/generate-database-values/index.ts
```

## Пример сгенерированного файла

```yaml
# This file is automatically generated and should not be edited manually!
# Generated database values for backend in production environment
# Database: backend_db
# User: backend_user

nameOverride: postgresql-backend
fullnameOverride: postgresql-backend
image:
  repository: postgres
  tag: 16-alpine
  pullPolicy: IfNotPresent
service:
  type: ClusterIP
  port: 5432
persistence:
  enabled: true
  storageClass: ""
  size: 20Gi
  accessMode: ReadWriteOnce
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 250m
    memory: 512Mi
database:
  name: backend_db
  user: backend_user
securityContext:
  runAsUser: 999
  runAsGroup: 999
  fsGroup: 999
```

## Деплой базы данных

После генерации файлов, задеплойте PostgreSQL:

```bash
# Development
helm install postgresql-backend ./infra/helmcharts/postgresql \
  --namespace default \
  --set database.password=dev_password \
  -f infra/overrides/development/postgresql-backend.yaml

# Production
helm install postgresql-backend ./infra/helmcharts/postgresql \
  --namespace production \
  --set database.password=$DB_PASSWORD \
  -f infra/overrides/production/postgresql-backend.yaml
```

## Добавление новой БД для сервиса

1. Создайте директорию для миграций:

   ```bash
   mkdir -p infra/databases/{service}-db/migrations
   ```

2. Создайте `data-source.ts` в `infra/databases/{service}-db/`

3. Обновите `services.yaml`:

   ```yaml
   - name: my-service
     database:
       enabled: true
       name: my_service_db
       user: my_service_user
   ```

4. Запустите генератор:

   ```bash
   pnpm run generate
   ```

5. Добавьте `DB_PASSWORD` для нового сервиса в GitHub Secrets

## Переменные окружения для сервиса

После генерации, обновите `service.yaml` вашего сервиса:

```yaml
env:
  DB_HOST: postgresql-{service}
  DB_PORT: "5432"
  DB_NAME: {service}_db
  DB_USER: {service}_user
  # DB_PASSWORD передается из GitHub Secrets
```

Затем запустите `pnpm run generate` для обновления overrides.
