# Database Values Generator

Автоматически генерирует Helm values файлы для PostgreSQL баз данных на основе конфигурации сервисов.

## Как это работает

1. Читает `services.yaml` и находит все сервисы с `database.enabled: true`
2. Для каждого сервиса ищет конфигурацию в `infra/databases/{service}-db/service.yaml`
3. Генерирует два файла для каждого сервиса:
   - `infra/overrides/development/postgresql-{service}.yaml`
   - `infra/overrides/production/postgresql-{service}.yaml`
4. Мержит базовые значения из `infra/helmcharts/postgresql/values.yaml` с настройками из `service.yaml`

## Конфигурация сервиса

### 1. В `services.yaml` добавьте секцию `database`:

```yaml
services:
  nest:
    - name: backend
      description: Backend service (NestJS)
      database:
        enabled: true
        name: backend_db # опционально, по умолчанию: {service}_db
        user: backend_user # опционально, по умолчанию: {service}_user
```

### 2. Создайте `infra/databases/{service}-db/service.yaml`:

```yaml
# Database configuration for backend service

# Базовая конфигурация (применяется ко всем окружениям)
persistence:
  size: 10Gi

resources:
  limits:
    cpu: 250m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 128Mi

# Environment-specific overrides
overrides:
  production:
    resources:
      limits:
        cpu: 500m
        memory: 500Mi
      requests:
        cpu: 100m
        memory: 150Mi
  development:
    # Development использует базовые ресурсы выше
```

### Кастомные свойства

Любые дополнительные свойства, которые не распознаются генератором, будут скопированы в финальный файл as-is:

```yaml
# Кастомное свойство - будет добавлено в итоговый файл
customAnnotations:
  monitoring: enabled
  backup: daily

persistence:
  size: 15Gi
```

## Приоритет настроек

Генератор применяет настройки в следующем порядке (от низшего к высшему):

1. **Базовые значения** из `infra/helmcharts/postgresql/values.yaml`
2. **Environment overrides из базового чарта** `values.yaml` → `overrides.{environment}`
3. **Базовые настройки из service.yaml** (верхний уровень)
4. **Environment-specific overrides из service.yaml** → `overrides.{environment}` (наивысший приоритет)

### Пример приоритетов

**Сценарий 1:** `service.yaml` не содержит `persistence`

- Development: использует `values.yaml` → `overrides.development.persistence.size` = `5Gi`
- Production: использует `values.yaml` → `overrides.production.persistence.size` = `20Gi`

**Сценарий 2:** `service.yaml` содержит `persistence.size: 10Gi`

- Development: использует `service.yaml` → `persistence.size` = `10Gi` (переопределяет `5Gi`)
- Production: использует `service.yaml` → `persistence.size` = `10Gi` (переопределяет `20Gi`)

**Сценарий 3:** `service.yaml` содержит `overrides.production.persistence.size: 15Gi`

- Development: использует базовое значение из `service.yaml` или `values.yaml`
- Production: использует `service.yaml` → `overrides.production.persistence.size` = `15Gi` (наивысший приоритет)

### Дефолтные значения (из базового чарта)

Если `service.yaml` не найден или не содержит определённых настроек, используются значения из `infra/helmcharts/postgresql/values.yaml`:

**Базовые значения:**

- **Persistence:** 10Gi
- **CPU:** 100m-500m
- **Memory:** 256Mi-512Mi
- **Image:** postgres:16-alpine

**Environment overrides (development):**

- **Persistence:** 5Gi
- **CPU:** 50m-250m
- **Memory:** 128Mi-256Mi

**Environment overrides (production):**

- **Persistence:** 20Gi
- **CPU:** 250m-1000m
- **Memory:** 512Mi-1Gi

## Использование

Генератор запускается автоматически при выполнении:

```bash
pnpm run generate
```

Или отдельно:

```bash
tsx infra/generate/generate-database-values/index.ts
```

## Пример сгенерированного файла

**Production:**

```yaml
# This file is automatically generated and should not be edited manually!
# Generated database values for backend in production environment
# Database: backend_db
# User: backend_user

nameOverride: postgresql-backend
fullnameOverride: postgresql-backend
image:
  repository: postgres
  tag: 16-alpine
  pullPolicy: IfNotPresent
service:
  type: ClusterIP
  port: 5432
persistence:
  enabled: true
  storageClass: ""
  size: 10Gi
  accessMode: ReadWriteOnce
resources:
  limits:
    cpu: 500m
    memory: 500Mi
  requests:
    cpu: 100m
    memory: 150Mi
database:
  name: backend_db
  user: backend_user
securityContext:
  runAsUser: 999
  runAsGroup: 999
  fsGroup: 999
customAnnotations:
  monitoring: enabled
  backup: daily
```

**Development:**

```yaml
# Development использует базовые ресурсы (250m CPU, 256Mi Memory)
persistence:
  size: 10Gi # Из базовой конфигурации service.yaml
resources:
  limits:
    cpu: 250m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 128Mi
```

## Деплой базы данных

После генерации файлов, задеплойте PostgreSQL:

```bash
# Development
helm install postgresql-backend ./infra/helmcharts/postgresql \
  --namespace default \
  --set database.password=dev_password \
  -f infra/overrides/development/postgresql-backend.yaml

# Production
helm install postgresql-backend ./infra/helmcharts/postgresql \
  --namespace production \
  --set database.password=$DB_PASSWORD \
  -f infra/overrides/production/postgresql-backend.yaml
```

## Добавление новой БД для сервиса

### Автоматически (рекомендуется)

Используйте генератор сервисов:

```bash
pnpm run generate:service
```

Генератор автоматически создаст:

- `infra/databases/{service}-db/service.yaml` с конфигурацией ресурсов
- `infra/databases/{service}-db/init.sql` с шаблоном схемы
- Запись в `services.yaml` с `database.enabled: true`

### Вручную

1. Создайте директорию для базы данных:

   ```bash
   mkdir -p infra/databases/{service}-db
   ```

2. Создайте `infra/databases/{service}-db/service.yaml`:

   ```yaml
   # Базовая конфигурация
   persistence:
     size: 10Gi

   resources:
     limits:
       cpu: 250m
       memory: 256Mi
     requests:
       cpu: 50m
       memory: 128Mi

   # Environment-specific overrides
   overrides:
     production:
       resources:
         limits:
           cpu: 500m
           memory: 500Mi
         requests:
           cpu: 100m
           memory: 150Mi
     development:
       # Development использует базовые ресурсы
   ```

3. (Опционально) Создайте `init.sql` для начальной схемы

4. Обновите `services.yaml`:

   ```yaml
   - name: my-service
     database:
       enabled: true
   ```

5. Запустите генератор:

   ```bash
   pnpm run generate
   ```

6. Добавьте `DB_PASSWORD` для нового сервиса в GitHub Secrets

## Переменные окружения для сервиса

После генерации, обновите `service.yaml` вашего сервиса:

```yaml
env:
  DB_HOST: postgresql-{service}
  DB_PORT: "5432"
  DB_NAME: {service}_db
  DB_USER: {service}_user
  # DB_PASSWORD передается из GitHub Secrets
```

Затем запустите `pnpm run generate` для обновления overrides.
