name: "Deploy with Helm"
description: "Deploy service using Helm chart"

inputs:
  service-name:
    description: "Name of the service to deploy"
    required: true
  service-type:
    description: "Type of service (nest or next)"
    required: true
  version:
    description: "Version tag for the Docker image"
    required: true
  docker-hub-username:
    description: "Docker Hub username"
    required: true
  canary-enabled:
    description: "Enable canary deployment"
    required: false
    default: "false"
  canary-replicas:
    description: "Number of canary replicas"
    required: false
    default: "1"
  atomic:
    description: "Use atomic deployment"
    required: false
    default: "false"
  jwt-secret:
    description: "JWT secret for authentication"
    required: false
    default: ""
  db-password:
    description: "Database password"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Deploy with Helm
      shell: bash
      run: |
        SERVICE_NAME="${{ inputs.service-name }}"
        SERVICE_TYPE="${{ inputs.service-type }}"
        VERSION="${{ inputs.version }}"
        DOCKER_HUB_USERNAME="${{ inputs.docker-hub-username }}"
        CANARY_ENABLED="${{ inputs.canary-enabled }}"
        CANARY_REPLICAS="${{ inputs.canary-replicas }}"
        USE_ATOMIC="${{ inputs.atomic }}"
        JWT_SECRET="${{ inputs.jwt-secret }}"
        DB_PASSWORD="${{ inputs.db-password }}"

        # Determine Helm chart path
        if [ "$SERVICE_TYPE" = "nest" ]; then
          CHART_PATH="./infra/helmcharts/backend-service"
        elif [ "$SERVICE_TYPE" = "next" ]; then
          CHART_PATH="./infra/helmcharts/frontend-service"
        else
          echo "Error: Unknown service type $SERVICE_TYPE"
          exit 1
        fi

        OVERRIDES_FILE="./infra/overrides/production/$SERVICE_NAME.yaml"

        echo "Deploying $SERVICE_NAME"
        echo "Chart: $CHART_PATH"
        echo "Version: $VERSION"
        echo "Canary enabled: $CANARY_ENABLED"
        echo "Atomic: $USE_ATOMIC"

        # Check if release exists
        RELEASE_EXISTS=$(helm list -q | grep -x "$SERVICE_NAME" || echo "")

        if [ "$CANARY_ENABLED" = "true" ]; then
          # CANARY mode: only deploy canary pods, don't touch stable
          echo "Deploying CANARY only (stable deployment unchanged)"
          
          if [ -n "$RELEASE_EXISTS" ]; then
            # Release exists: use --reuse-values to keep stable deployment unchanged
            helm upgrade "$SERVICE_NAME" "$CHART_PATH" \
              --reuse-values \
              --set canary.enabled=true \
              --set canary.replicas="$CANARY_REPLICAS" \
              --set canary.image.tag="production-${SERVICE_NAME}-v${VERSION}" \
              --set canary.image.repository="$DOCKER_HUB_USERNAME/supreme" \
              --set secrets.JWT_SECRET="$JWT_SECRET" \
              --set secrets.DB_PASSWORD="$DB_PASSWORD" \
              --wait --timeout 5m
          else
            # First deploy: need full values
            helm upgrade "$SERVICE_NAME" "$CHART_PATH" \
              -f "$OVERRIDES_FILE" \
              --set image.repository="$DOCKER_HUB_USERNAME/supreme" \
              --set canary.enabled=true \
              --set canary.replicas="$CANARY_REPLICAS" \
              --set canary.image.tag="production-${SERVICE_NAME}-v${VERSION}" \
              --set canary.image.repository="$DOCKER_HUB_USERNAME/supreme" \
              --set secrets.JWT_SECRET="$JWT_SECRET" \
              --set secrets.DB_PASSWORD="$DB_PASSWORD" \
              --install \
              --wait --timeout 5m
          fi
        else
          # PRODUCTION mode: update stable deployment, disable canary
          echo "Deploying to PRODUCTION (canary disabled)"
          
          if [ "$USE_ATOMIC" = "true" ]; then
            helm upgrade "$SERVICE_NAME" "$CHART_PATH" \
              -f "$OVERRIDES_FILE" \
              --set image.tag="production-${SERVICE_NAME}-v${VERSION}" \
              --set image.repository="$DOCKER_HUB_USERNAME/supreme" \
              --set canary.enabled=false \
              --set secrets.JWT_SECRET="$JWT_SECRET" \
              --set secrets.DB_PASSWORD="$DB_PASSWORD" \
              --install \
              --wait --timeout 5m \
              --atomic
          else
            helm upgrade "$SERVICE_NAME" "$CHART_PATH" \
              -f "$OVERRIDES_FILE" \
              --set image.tag="production-${SERVICE_NAME}-v${VERSION}" \
              --set image.repository="$DOCKER_HUB_USERNAME/supreme" \
              --set canary.enabled=false \
              --set secrets.JWT_SECRET="$JWT_SECRET" \
              --set secrets.DB_PASSWORD="$DB_PASSWORD" \
              --install \
              --wait --timeout 5m
          fi
        fi

        echo "Deployment completed successfully"
        kubectl get pods -l app.kubernetes.io/name="$SERVICE_NAME"
