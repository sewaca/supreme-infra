name: 'Deploy with Helm'
description: 'Deploy service using Helm chart'

inputs:
  service-name:
    description: 'Name of the service to deploy'
    required: true
  service-type:
    description: 'Type of service (nest or next)'
    required: true
  version:
    description: 'Version tag for the Docker image'
    required: true
  docker-hub-username:
    description: 'Docker Hub username'
    required: true
  canary-enabled:
    description: 'Enable canary deployment'
    required: false
    default: 'false'
  canary-replicas:
    description: 'Number of canary replicas'
    required: false
    default: '1'
  atomic:
    description: 'Use atomic deployment'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Deploy with Helm
      shell: bash
      run: |
        SERVICE_NAME="${{ inputs.service-name }}"
        SERVICE_TYPE="${{ inputs.service-type }}"
        VERSION="${{ inputs.version }}"
        DOCKER_HUB_USERNAME="${{ inputs.docker-hub-username }}"
        CANARY_ENABLED="${{ inputs.canary-enabled }}"
        CANARY_REPLICAS="${{ inputs.canary-replicas }}"
        USE_ATOMIC="${{ inputs.atomic }}"

        # Determine Helm chart path
        if [ "$SERVICE_TYPE" = "nest" ]; then
          CHART_PATH="./infra/helmcharts/backend-service"
        elif [ "$SERVICE_TYPE" = "next" ]; then
          CHART_PATH="./infra/helmcharts/frontend-service"
        else
          echo "Error: Unknown service type $SERVICE_TYPE"
          exit 1
        fi

        OVERRIDES_FILE="./infra/overrides/production/$SERVICE_NAME.yaml"

        echo "Deploying $SERVICE_NAME"
        echo "Chart: $CHART_PATH"
        echo "Version: $VERSION"
        echo "Canary enabled: $CANARY_ENABLED"

        # Check if release exists
        RELEASE_EXISTS=$(helm list -q | grep -x "$SERVICE_NAME" || echo "")

        if [ "$CANARY_ENABLED" = "true" ]; then
          # CANARY mode: only deploy canary pods, don't touch stable
          echo "Deploying CANARY only (stable deployment unchanged)"
          
          if [ -n "$RELEASE_EXISTS" ]; then
            # Release exists: use --reuse-values to keep stable deployment unchanged
            HELM_CMD="helm upgrade $SERVICE_NAME $CHART_PATH"
            HELM_CMD="$HELM_CMD --reuse-values"
            HELM_CMD="$HELM_CMD --set canary.enabled=true"
            HELM_CMD="$HELM_CMD --set canary.replicas=$CANARY_REPLICAS"
            HELM_CMD="$HELM_CMD --set canary.image.tag=production-${SERVICE_NAME}-v${VERSION}"
            HELM_CMD="$HELM_CMD --set canary.image.repository=$DOCKER_HUB_USERNAME/supreme"
          else
            # First deploy: need full values
            HELM_CMD="helm upgrade $SERVICE_NAME $CHART_PATH -f $OVERRIDES_FILE"
            HELM_CMD="$HELM_CMD --set image.repository=$DOCKER_HUB_USERNAME/supreme"
            HELM_CMD="$HELM_CMD --set canary.enabled=true"
            HELM_CMD="$HELM_CMD --set canary.replicas=$CANARY_REPLICAS"
            HELM_CMD="$HELM_CMD --set canary.image.tag=production-${SERVICE_NAME}-v${VERSION}"
            HELM_CMD="$HELM_CMD --set canary.image.repository=$DOCKER_HUB_USERNAME/supreme"
            HELM_CMD="$HELM_CMD --install"
          fi
        else
          # PRODUCTION mode: update stable deployment, disable canary
          echo "Deploying to PRODUCTION (canary disabled)"
          HELM_CMD="helm upgrade $SERVICE_NAME $CHART_PATH -f $OVERRIDES_FILE"
          HELM_CMD="$HELM_CMD --set image.tag=production-${SERVICE_NAME}-v${VERSION}"
          HELM_CMD="$HELM_CMD --set image.repository=$DOCKER_HUB_USERNAME/supreme"
          HELM_CMD="$HELM_CMD --set canary.enabled=false"
          HELM_CMD="$HELM_CMD --install"
        fi

        HELM_CMD="$HELM_CMD --wait --timeout 5m"

        if [ "$USE_ATOMIC" = "true" ]; then
          HELM_CMD="$HELM_CMD --atomic"
        fi

        echo "Running: $HELM_CMD"
        eval $HELM_CMD

        echo "Deployment completed"
        kubectl get pods -l app.kubernetes.io/name="$SERVICE_NAME"
