# CI/CD Pipeline и Pre-commit проверки

Этот документ описывает настройку непрерывной интеграции и непрерывного развертывания, а также pre-commit проверки качества для монопрепозитория supreme-infra.

## CI Pipeline

CI pipeline запускается при пуше в ветку `main` и в pull requests. Он включает селективные проверки, которые запускаются только при изменении файлов, связанных с сервисами.

### Main CI Workflow (`.github/workflows/ci.yml`)

**Триггеры**:
- Push в ветку `main`
- Pull requests

**Jobs**:

#### 1. Селективные проверки (`selective-checks`)
- **Назначение**: Определяет, должны ли запускаться проверки сервисов
- **Логика**: Проверяет, были ли изменены файлы в `services/` или `package.json`
- **Вывод**: `should-skip-service-checks` boolean

#### 2. Линтинг (`check-lint`)
- **Запускается**: Только если обнаружены изменения сервисов
- **Инструменты**: Biome linter
- **Команда**: `pnpm lint`
- **Назначение**: Обеспечивает соответствие стилю кода

#### 3. Компиляция TypeScript (`check-tsc`)
- **Запускается**: Только если обнаружены изменения сервисов
- **Инструменты**: TypeScript компилятор
- **Команда**: `pnpm -r tsc`
- **Назначение**: Валидирует компиляцию TypeScript во всех сервисах

#### 4. Unit тесты (`check-unit`)
- **Запускается**: Только если обнаружены изменения сервисов
- **Инструменты**: Vitest с покрытием
- **Команда**: `pnpm -r unit:coverage`
- **Назначение**: Запускает unit тесты с отчетами о покрытии
- **Вывод**: Отчеты о покрытии в директориях `coverage/`

#### 5. E2E тесты (`test-e2e`)
- **Запускается**: Всегда (не селективно)
- **Инструменты**: Playwright
- **Назначение**: End-to-end тестирование приложения
- **Конфигурация**: Использует `.github/workflows/jobs/test-e2e/`

## Проверки безопасности

Сканирование безопасности запускается для всех сервисов с использованием специализированных actions проверок безопасности.

### Workflow проверок безопасности (`.github/workflows/security-checks.yml`)

**Триггеры**:
- Push в ветку `main`
- Pull requests

**Jobs**:

#### Сканирование безопасности NestJS (`security-scan-nest`)
- **Матрица**: Все NestJS сервисы из `services.yaml`
- **Action**: `.github/workflows/jobs/nest-application-security-check/`
- **Назначение**: Сканирование уязвимостей безопасности для NestJS сервисов

#### Сканирование безопасности Next.js (`security-scan-next`)
- **Матрица**: Все Next.js сервисы из `services.yaml`
- **Action**: `.github/workflows/jobs/next-application-security-check/`
- **Назначение**: Сканирование уязвимостей безопасности для Next.js сервисов

## Pre-commit проверки

Pre-commit хуки обеспечивают качество кода перед разрешением коммитов. Система использует как клиентские pre-commit хуки, так и серверные GitHub Actions.

### Pre-commit Workflow (`.github/workflows/precommit-checks.yml`)

**Триггеры**: Pull requests

**Особенности**:
- **Автоматические исправления**: Madara Robot автоматически применяет исправления pre-commit
- **Auto-commit**: Изменения коммитятся обратно в ветку PR
- **Разрешения**: Права на запись в содержимое PR и pull requests

**Процесс**:
1. Устанавливает pre-commit хуки
2. Запускает все pre-commit проверки
3. Если обнаружены изменения, коммитит их с сообщением: `"<Madara Robot>: Apply pre-commit hooks fixes"`
4. Пушит изменения обратно в ветку PR

### Pre-commit Configuration

The project uses [pre-commit](https://pre-commit.com/) framework with hooks for:
- Code formatting (Biome)
- Linting (Biome)
- TypeScript compilation checks
- Import sorting
- Trailing whitespace removal
- End-of-file fixes

## Валидация заголовков PR

Все pull requests должны следовать определенным соглашениям по заголовкам для правильного версионирования.

### Валидация заголовков PR (`.github/workflows/validate-pr-title.yml`)

**Триггеры**: Pull request открыт, отредактирован или синхронизирован

**Правила валидации**:
Заголовки PR должны начинаться с одного из разрешенных тегов:
- `major:` - Breaking changes
- `minor:` - Новые функции (обратная совместимость)
- `fix:` - Исправления багов
- `chore:` - Задачи обслуживания (без повышения версии)

**Примеры правильных заголовков PR**:
```
major: Refactored authentication system
minor(ui): Added dark mode toggle
fix: Fixed memory leak in data processing
chore: Updated dependencies
```

**Скрипт валидации**: `infra/checks/check-pr-title/check-pr-title.py`

## Генерация инфраструктуры

Автоматическая генерация инфраструктуры обеспечивает синхронизацию всех конфигов.

### Генерация инфраструктуры (`.github/workflows/generate-infrastructure.yml`)

**Триггеры**: Pull requests

**Процесс**:
1. Запускает supreme генератор инфраструктуры (`pnpm run generate`)
2. Автоматически обновляет все файлы инфраструктуры
3. Коммитит изменения обратно в PR с сообщением: `"<Madara Robot>: Apply infrastructure generator"`

**Generated Files**:
- Helm values files (`infra/overrides/`)
- GitHub workflow configurations
- Service router configurations
- Security check matrices

## Madara Robot

Madara Robot - это автоматизированная система, которая обрабатывает различные задачи обслуживания:

### Обязанности

1. **Pre-commit исправления**: Применяет автоматическое форматирование кода и исправления
2. **Обновления инфраструктуры**: Поддерживает синхронизацию всех конфигов инфраструктуры
3. **Управление PR**: Обеспечивает соответствие PR стандартам качества

### Конфигурация

**Git конфигурация**:
```bash
git config --global user.email "246592117+madara-robot@users.noreply.github.com"
git config --global user.name "madara-robot"
```

**Требуемые разрешения**:
- `contents: write` - Для коммита изменений
- `pull-requests: write` - Для комментариев PR и обновлений

## Quality Gates

### Обязательные проверки для слияния PR

1. **Линтинг**: Должен пройти Biome линтинг
2. **TypeScript**: Должен компилироваться без ошибок
3. **Unit тесты**: Должны пройти с минимальным покрытием
4. **E2E тесты**: Должны пройти
5. **Security сканирование**: Должно пройти для всех сервисов
6. **Заголовок PR**: Должен следовать соглашениям именования

### Селективное выполнение

Проверки конкретных сервисов (линтинг, TypeScript, unit тесты) запускаются только когда:
- Изменены файлы в директории `services/`, ИЛИ
- Изменен `package.json`

Эта оптимизация снижает время выполнения CI для изменений только инфраструктуры.

## Локальная настройка разработки

### Pre-commit хуки (локально)

```bash
# Установить pre-commit хуки локально
pip install pre-commit
pre-commit install

# Запустить pre-commit на всех файлах
pre-commit run --all-files

# Запустить конкретный хук
pre-commit run biome-check --all-files
```

### Запуск CI проверок локально

```bash
# Линтинг всего кода
pnpm lint

# Проверка типов всех сервисов
pnpm -r tsc

# Запуск unit тестов
pnpm -r unit

# Запуск e2e тестов
cd e2e && pnpm run test:e2e

# Запуск проверок безопасности (требует Docker)
# Используйте GitHub Actions локально или проверяйте безопасность отдельных сервисов
```

## Устранение неисправностей

### Распространенные проблемы CI

#### "Pre-commit проверки провалились"
- Запустите `pre-commit run --all-files` локально
- Исправьте любые проблемы форматирования или линтинга
- Закоммитьте исправления

#### "Валидация заголовка PR провалилась"
- Убедитесь, что заголовок PR начинается с `major:`, `minor:`, `fix:` или `chore:`
- Следуйте паттерну: `{tag}: {description}`

#### "Security сканирование провалилось"
- Проверьте уязвимые зависимости
- Обновите пакеты до последних безопасных версий
- Просмотрите security advisories

#### "Генерация инфраструктуры провалилась"
- Запустите `pnpm run generate` локально
- Проверьте синтаксические ошибки в `services.yaml`
- Убедитесь, что все конфигурации сервисов валидны

### Селективные проверки не работают

Если селективные проверки не запускаются, когда должны:
- Проверьте пути файлов в проверке измененных файлов
- Убедитесь, что PR имеет правильную базовую ветку
- Убедитесь, что файлы `services/` или `package.json` действительно изменены

### Madara Robot не коммитит

Если Madara Robot не может закоммитить изменения:
- Проверьте разрешения репозитория для PAT токена
- Убедитесь, что правила защиты веток позволяют force push
- Проверьте наличие merge конфликтов

## Интеграция с рабочим процессом разработки

Настройка CI/CD бесшовно интегрируется с процессом разработки:

1. **Локальная разработка**: Используйте pre-commit хуки для немедленной обратной связи
2. **Создание PR**: Автоматизированная валидация и исправления через Madara Robot
3. **Code Review**: Все проверки качества должны пройти перед слиянием
4. **Развертывание**: Автоматическое продвижение через canary и production стадии

Это обеспечивает согласованное качество кода и автоматизированное обслуживание во всем монопрепозитории.
